#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import time
import json
import logging
import threading

from dotenv import load_dotenv
from flask import Flask, request, abort

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage

import paho.mqtt.client as mqtt

# ------------------ åŸºæœ¬è¨­å®š ------------------ #

load_dotenv()

CHANNEL_ACCESS_TOKEN = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")
CHANNEL_SECRET = os.getenv("LINE_CHANNEL_SECRET")

if not CHANNEL_ACCESS_TOKEN or not CHANNEL_SECRET:
    print("âŒ è«‹å…ˆåœ¨ .env ä¸­è¨­å®š LINE_CHANNEL_ACCESS_TOKEN / LINE_CHANNEL_SECRET")
    sys.exit(1)

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

logging.basicConfig(level=logging.INFO)

app = Flask(__name__)

# ------------------ MQTT è¨­å®š ------------------ #

MQTT_BROKER = "localhost"      # YOLO è·Ÿ LINE åœ¨åŒä¸€å°æ¨¹è“æ´¾
MQTT_PORT = 1883
MQTT_TOPIC = "queue/people"

current_people = None
last_update_ts = None


def on_mqtt_message(client, userdata, msg):
    global current_people, last_update_ts
    try:
        payload = msg.payload.decode("utf-8")
        data = json.loads(payload)
        current_people = data.get("people")
        last_update_ts = data.get("ts")
        logging.info(f"ğŸ“¥ MQTT äººæ•¸æ›´æ–°ï¼š{current_people}")
    except Exception as e:
        logging.warning(f"MQTT è§£æéŒ¯èª¤ï¼š{e}")


def start_mqtt():
    client = mqtt.Client()
    client.on_message = on_mqtt_message
    client.connect(MQTT_BROKER, MQTT_PORT, 60)
    client.subscribe(MQTT_TOPIC)
    client.loop_start()


# ------------------ Flask è·¯ç”± ------------------ #

@app.route("/", methods=["GET"])
def index():
    return "LINE Bot (People Counter) is running.", 200


@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return "OK"


# ------------------ LINE è¨Šæ¯è™•ç† ------------------ #

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event: MessageEvent):
    text = event.message.text.strip().lower()

    if text == "people":
        if current_people is None:
            reply = "ç›®å‰å°šæœªæ”¶åˆ°äººæ•¸è³‡æ–™ â³"
        else:
            reply = f"ç›®å‰åµæ¸¬åˆ°äººæ•¸ï¼š{current_people} äºº ğŸ‘¥"

    elif text == "help":
        reply = (
            "å¯ç”¨æŒ‡ä»¤ï¼š\n"
            "- peopleï¼šæŸ¥è©¢ç›®å‰äººæ•¸\n"
            "- helpï¼šé¡¯ç¤ºæŒ‡ä»¤èªªæ˜"
        )

    else:
        reply = "è«‹è¼¸å…¥ people æŸ¥è©¢ç›®å‰äººæ•¸ ğŸ‘¥"

    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=reply)
    )


# ------------------ ä¸»ç¨‹å¼ ------------------ #

if __name__ == "__main__":
    # å•Ÿå‹• MQTTï¼ˆèƒŒæ™¯åŸ·è¡Œï¼‰
    start_mqtt()

    port = int(os.getenv("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
